<html lang="en">
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/pianopaypal/css/form.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <title>Payment Complete Page</title>
</head>
<body>
<div class="wrapper">
    <nav id="sidebar">
        <div class="sidebar-header">
            <b>Kindle County</b>
            <p>118 N Kindle St, Chicago, IL 60600</p>
        </div>
        <ul class="list-unstyled components">
            <li class="option">Summary</li>
            <li class="option">Record</li>
            <li class="option">Status</li>
            <li class="option">Activities (0)</li>
            <li class="option">Workflow</li>
            <li class="option">Inspections (6)</li>
            <li class="option">Fee (1)</li>
            <li class="selected"><a href="/pianopaypal/checkout">Payment</a></li>
            <li class="option">Contacts (1)</li>
            <li class="option">Professionals (0)</li>
            <li class="option">Communications)</li>
            <li class="option">Renewal Info</li>
        </ul>
    </nav>
    <div class="container">
        <table style="width: 400px">
            <tbody>
            <tr>
                <td style="width: 35%" class="align-middle">
                    <img id="accela-logo" src="/pianopaypal/image/accela.png"/>
                </td>
                <td style="width: 22%; padding-top: 14px" class="align-bottom">
                    <p>Civic Platform</p>
                </td>
                <td style="width: 5%; padding-top: 14px" class="align-bottom">
                    <p>&gt;</p>
                </td>
                <td style="width: 30%; padding-top: 14px" class="align-bottom">
                    <p class="label-bold">STANDARDTEST</p>
                </td>
            </tr>
            </tbody>
        </table>
        <div class="col-lg-12 col-md-12 col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-12 alert alert-info">
                            <div class="glyphicon glyphicon-info-sign">
                                <b class="alert-info">Payment Test Client</b>
                            </div>
                            <div>
                                <p>
                                    This is a surrogate for the Civic Platform used to test the Payment Adapter.
                                    No payment will be made, but only test details should be entered (e.g., credit-
                                    card numbers, phone numbers) as data will be sent to an external site.
                                </p>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary dropdown-toggle box-shadow" type="button"
                            data-toggle="dropdown" id="post-menu">
                        Menu
                        <span class="caret"></span>
                    </button>
                    <button type="submit" class="btn btn-primary box-shadow" id="post-refund">Refund</button>
                    <button type="submit" class="btn btn-primary box-shadow" id="post-void">Void</button>
                    <button type="submit" class="btn btn-primary box-shadow" id="post-receipt">Print Receipt</button>
                    <button type="submit" class="btn btn-primary box-shadow" id="post-help">Help</button>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <form id="payment-form" role="form">
                                <div class="row">
                                    <div class="form-group col-md-8">
                                        <p class="alert alert-success hide" role="alert" id="payment-status-ok"></p>
                                        <p class="alert alert-danger hide" role="alert" id="payment-status-error"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-2">
                                        <label for="amount" class="control-label">Amount</label>
                                        <input type="text" class="form-control form-control-ro"
                                               name="amount" id="amount" readonly/>
                                    </div>
                                    <div class="form-group col-md-2">
                                        <label for="paymentType" class="control-label">Payment Type</label>
                                        <input type="text" class="form-control form-control-ro"
                                               name="paymentType" id="paymentType" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="firstName" class="control-label">First Name</label>
                                        <input type="text" class="form-control form-control-ro" id="firstName"
                                               name="firstName" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="lastName" class="control-label">Last Name</label>
                                        <input type="text" class="form-control form-control-ro" id="lastName"
                                               name="lastName" readonly/>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-4">
                                        <label for="companyName" class="control-label">Business Name</label>
                                        <input type="text" class="form-control form-control-ro" id="companyName"
                                               name="companyName" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="addressStreet1" class="control-label">Street Address</label>
                                        <input type="text" class="form-control form-control-ro" id="addressStreet1"
                                               name="addressStreet1" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="addressStreet2" class="control-label">Street Address2</label>
                                        <input type="text" class="form-control form-control-ro" id="addressStreet2"
                                               name="addressStreet2" readonly/>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-4">
                                        <label for="addressCity" class="control-label">City</label>
                                        <input type="text" class="form-control form-control-ro" id="addressCity"
                                               name="addressCity" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="addressState" class="control-label">State</label>
                                        <input type="text" class="form-control form-control-ro" id="addressState"
                                               name="addressState" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="addressPostCode" class="control-label">Zip</label>
                                        <input type="text" class="form-control form-control-ro" id="addressPostCode"
                                               name="addressPostCode" readonly/>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-4">
                                        <label for="telephone" class="control-label">Telephone</label>
                                        <input type="text" class="form-control form-control-ro" id="telephone"
                                               name="telephone" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="email" class="control-label">Email Address</label>
                                        <input type="text" class="form-control form-control-ro" id="email"
                                               name="email" readonly/>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-4">
                                        <label for="accountNumber" class="control-label">Account Number</label>
                                        <input type="text" class="form-control form-control-ro" id="accountNumber"
                                               name="accountNumber" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="responseText" class="control-label">Response Text</label>
                                        <input type="text" class="form-control form-control-ro"
                                               name="responseText" id="responseText" readonly multiple="multiple" />
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="authorizationCode" class="control-label">Authorization Code</label>
                                        <input type="text" class="form-control form-control-ro" id="authorizationCode"
                                               name="authorizationCode" readonly/>
                                    </div>
                                </div>
                                <div class="row" id="cardDetails" hidden>
                                    <div class="form-group col-md-4">
                                        <label for="cardType" class="control-label">Card Type</label>
                                        <input type="text" class="form-control form-control-ro" id="cardType"
                                               name="cardType" readonly/>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="cardValidity" class="control-label">Card Validity</label>
                                        <input type="text" class="form-control form-control-ro" id="cardValidity"
                                               name="cardValidity" readonly/>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
       
        const queryString = window.location.search;
        console.log(queryString);
        const urlParams = new URLSearchParams(queryString);
        let txId = urlParams.get('paymentId');
        if(txId==null || txId==""){
        	let path = window.location.pathname;
            txId = encodeURI(path.substring(path.lastIndexOf('/') + 1, path.length)); 
        }
     
        let query = {
            url: '/pianopaypal/api/transaction/' + txId,
            type: 'GET',
            accept: 'application/json; charset=UTF-8',
            retries: 10,
            success: populate,
            error: onFail
        };
        $.ajax(query)

        function onFail(xhr, textStatus, errorThrown) {
            console.log('failed');
            if (xhr.status === 404 && query.retries-- > 0) {
                setTimeout(function () {
                    $.ajax(query);
                }, 1000);
            } else {
                console.log("error querying payment response",
                    textStatus, errorThrown);
            }
        }
    });

    function populate(data) {
        console.log('success', data);
        let contact = data["contact"];
        let instrument = data["instrument"];
        let outcome = data["paymentOutcome"];
        setPaymentStatus(outcome['responseCode'], outcome['description']);
        $('#amount').val(currencyFormat(data["amount"]));
        $("#responseText").val(outcome["responseText"]);
        $("#responseCode").val(outcome["responseCode"]);
        $("#authorizationCode").val(outcome["authorizationCode"]);
        let name = data["personalName"];
        $("#firstName").val(name["firstName"]);
        $("#lastName").val(name["lastName"]);
        $("#companyName").val(contact["company"]);
        $("#addressStreet1").val(contact["street1"]);
        $("#addressStreet2").val(contact["street2"]);
        $("#addressState").val(contact["state"]);
        $("#addressCity").val(contact["city"]);
        $("#addressPostCode").val(contact["postCode"]);
        $("#telephone").val(contact["telephone"]);
        $("#email").val(contact["email"]);
        $("#accountNumber").val(instrument["number"]);
        if(instrument['type'] === 'CC') {
            $("label[for='accountNumber']").text("Card Number");
            $("#paymentType").val('Credit Card');
            let expiryDate = instrument["expiryDate"];
            $("#cardValidity").val(expiryDate["month"] + ' ' + expiryDate["year"]);
            $("#cardType").val(instrument["issuer"].toUpperCase());
        } else {
            $("label[for='accountNumber']").text('Account Number');
            $("#paymentType").val('eCheck');
            $("#cardDetails").hide();
        }
    }

    function setPaymentStatus(responseCode, description) {
        if (responseCode === 'A01') {
            let statusField = $('#payment-status-ok');
            statusField.addClass('show');
            statusField.html(description + ' (' + responseCode + ')');
        } else {
            let statusField = $('#payment-status-error');
            statusField.addClass('show');
            statusField.html('Online payment failed: ' + description + ' ('
                + responseCode + ')<br>' + 'Please contact your agency administrator for help');
            $('#post-refund').prop('disabled', true);
            $('#post-void').prop('disabled', true);
        }
    }

    function currencyFormat(amount) {
        let formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
        });
        return formatter.format(amount);
    }
</script>

</body>
</html>